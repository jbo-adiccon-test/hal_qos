<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_classification_8c_source" xml:lang="en-US">
<title>classification.c</title>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_classification_8c_source_1l00001"/>00001 <emphasis role="comment">//</emphasis>
<anchor xml:id="_classification_8c_source_1l00002"/>00002 <emphasis role="comment">//&#32;Created&#32;by&#32;limberg&#32;on&#32;12.01.2022.</emphasis>
<anchor xml:id="_classification_8c_source_1l00003"/>00003 <emphasis role="comment">//</emphasis>
<anchor xml:id="_classification_8c_source_1l00004"/>00004 
<anchor xml:id="_classification_8c_source_1l00005"/>00005 <emphasis role="preprocessor">#include&#32;&lt;stdio.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00006"/>00006 <emphasis role="preprocessor">#include&#32;&lt;string.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00007"/>00007 <emphasis role="preprocessor">#include&#32;&lt;stdlib.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00008"/>00008 <emphasis role="preprocessor">#include&#32;&lt;limits.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00009"/>00009 <emphasis role="preprocessor">#include&#32;&lt;sys/stat.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00010"/>00010 <emphasis role="preprocessor">#include&#32;&lt;errno.h&gt;</emphasis>
<anchor xml:id="_classification_8c_source_1l00011"/>00011 
<anchor xml:id="_classification_8c_source_1l00012"/>00012 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_classification_8h">classification.h</link>&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00013"/>00013 
<anchor xml:id="_classification_8c_source_1l00014"/><link linkend="_classification_8c_1aac44c69433c499f8f6b289be48d15586">00014</link> <emphasis role="preprocessor">#define&#32;CLASS_MASK_IPV4&#32;32</emphasis>
<anchor xml:id="_classification_8c_source_1l00015"/><link linkend="_classification_8c_1ab68ef077d811c3905bca07df9889a818">00015</link> <emphasis role="preprocessor">#define&#32;CLASS_MASK_IPV6&#32;128</emphasis>
<anchor xml:id="_classification_8c_source_1l00016"/>00016 
<anchor xml:id="_classification_8c_source_1l00017"/><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">00017</link> <emphasis role="preprocessor">#define&#32;CLASS_FW_FILENAME&#32;&quot;/tmp/qos_rules.sh&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00018"/><link linkend="_classification_8c_1a0036c19278e6b8c0eea72c195f9efcd0">00018</link> <emphasis role="preprocessor">#define&#32;CLASS_FW_DEBUG&#32;&quot;/home/tester/qos_rules.sh&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00019"/><link linkend="_classification_8c_1a1cb9a98219b89cd96775287b7109ae2f">00019</link> <emphasis role="preprocessor">#define&#32;CLASS_FW_RELOAD_FILENAME&#32;&quot;/etc/utopia/service.d/firewall_log_handle.sh&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00020"/><link linkend="_classification_8c_1a95e8153ae3cb6a746a8a9f7a5700270e">00020</link> <emphasis role="preprocessor">#define&#32;CLASS_FW_RELOAD_DEBUG&#32;&quot;/home/tester/firewall_log_handle.sh&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00021"/><link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">00021</link> <emphasis role="preprocessor">#define&#32;CLASS_IPTABLES_MANGLE_CMD&#32;&quot;iptables&#32;-t&#32;mangle&quot;</emphasis>
<anchor xml:id="_classification_8c_source_1l00022"/>00022 
<anchor xml:id="_classification_8c_source_1l00023"/><link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1db">00023</link> <emphasis role="keyword">enum&#32;class</emphasis>_table
<anchor xml:id="_classification_8c_source_1l00024"/>00024 {
<anchor xml:id="_classification_8c_source_1l00025"/><link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">00025</link> &#32;&#32;&#32;&#32;<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>&#32;=&#32;(1&#32;&lt;&lt;&#32;0),
<anchor xml:id="_classification_8c_source_1l00026"/><link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dbab4889de7d1672b8b83e5460efbca2db0">00026</link> &#32;&#32;&#32;&#32;<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dbab4889de7d1672b8b83e5460efbca2db0">IPTABLES_IPV6</link>&#32;=&#32;(1&#32;&lt;&lt;&#32;1),
<anchor xml:id="_classification_8c_source_1l00027"/>00027 };
<anchor xml:id="_classification_8c_source_1l00028"/>00028 
<anchor xml:id="_classification_8c_source_1l00033"/>00033 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;append_to_fw()
<anchor xml:id="_classification_8c_source_1l00034"/>00034 {
<anchor xml:id="_classification_8c_source_1l00035"/>00035 &#32;&#32;&#32;&#32;FILE&#32;*fp;
<anchor xml:id="_classification_8c_source_1l00036"/>00036 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*line&#32;=&#32;NULL;
<anchor xml:id="_classification_8c_source_1l00037"/>00037 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">size_t</emphasis>&#32;len&#32;=&#32;0;
<anchor xml:id="_classification_8c_source_1l00038"/>00038 
<anchor xml:id="_classification_8c_source_1l00039"/>00039 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!(fp&#32;=&#32;fopen(<link linkend="_classification_8c_1a1cb9a98219b89cd96775287b7109ae2f">CLASS_FW_RELOAD_FILENAME</link>,&#32;<emphasis role="stringliteral">&quot;a+&quot;</emphasis>)))
<anchor xml:id="_classification_8c_source_1l00040"/>00040 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00041"/>00041 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Cannot&#32;open&#32;file&#32;&quot;</emphasis><link linkend="_classification_8c_1a1cb9a98219b89cd96775287b7109ae2f">CLASS_FW_RELOAD_FILENAME</link><emphasis role="stringliteral">&quot;:&#32;%s\n&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00042"/>00042 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00043"/>00043 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00044"/>00044 
<anchor xml:id="_classification_8c_source_1l00045"/>00045 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(getline(&amp;line,&#32;&amp;len,&#32;fp)&#32;!=&#32;-1)
<anchor xml:id="_classification_8c_source_1l00046"/>00046 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00047"/>00047 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(strstr(line,&#32;<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>))
<anchor xml:id="_classification_8c_source_1l00048"/>00048 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00049"/>00049 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00050"/>00050 
<anchor xml:id="_classification_8c_source_1l00051"/>00051 &#32;&#32;&#32;&#32;fprintf(fp,&#32;<emphasis role="stringliteral">&quot;%s\n&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>);
<anchor xml:id="_classification_8c_source_1l00052"/>00052 &#32;&#32;&#32;&#32;fclose(fp);
<anchor xml:id="_classification_8c_source_1l00053"/>00053 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00054"/>00054 }
<anchor xml:id="_classification_8c_source_1l00055"/>00055 
<anchor xml:id="_classification_8c_source_1l00060"/>00060 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;revert_rules(){
<anchor xml:id="_classification_8c_source_1l00061"/>00061 &#32;&#32;&#32;&#32;FILE&#32;*fp&#32;=&#32;NULL;
<anchor xml:id="_classification_8c_source_1l00062"/>00062 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">size_t</emphasis>&#32;len&#32;=&#32;0;
<anchor xml:id="_classification_8c_source_1l00063"/>00063 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*line&#32;=&#32;NULL;
<anchor xml:id="_classification_8c_source_1l00064"/>00064 
<anchor xml:id="_classification_8c_source_1l00066"/>00066 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!(fp&#32;=&#32;fopen(<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>,&#32;<emphasis role="stringliteral">&quot;a+&quot;</emphasis>)))
<anchor xml:id="_classification_8c_source_1l00067"/>00067 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00068"/>00068 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Cannot&#32;open&#32;&quot;</emphasis><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link><emphasis role="stringliteral">&quot;:&#32;%s\n&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00069"/>00069 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00070"/>00070 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00071"/>00071 
<anchor xml:id="_classification_8c_source_1l00073"/>00073 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(chmod(<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>,&#32;S_IRWXU&#32;|&#32;S_IRWXG&#32;|&#32;S_IRWXO))
<anchor xml:id="_classification_8c_source_1l00074"/>00074 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Cannot&#32;change&#32;&quot;</emphasis><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link><emphasis role="stringliteral">&quot;&#32;permissions:&#32;%s\n&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00075"/>00075 
<anchor xml:id="_classification_8c_source_1l00076"/>00076 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(getline(&amp;line,&#32;&amp;len,&#32;fp)&#32;!=&#32;-1)&#32;{
<anchor xml:id="_classification_8c_source_1l00078"/>00078 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;line[20]&#32;=&#32;<emphasis role="charliteral">&apos;D&apos;</emphasis>;
<anchor xml:id="_classification_8c_source_1l00079"/>00079 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(system(line))&#32;{
<anchor xml:id="_classification_8c_source_1l00080"/>00080 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Failed&#32;to&#32;execute&#32;[%s]\n&quot;</emphasis>,&#32;line);
<anchor xml:id="_classification_8c_source_1l00081"/>00081 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00082"/>00082 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00083"/>00083 
<anchor xml:id="_classification_8c_source_1l00084"/>00084 &#32;&#32;&#32;&#32;fclose(fp);
<anchor xml:id="_classification_8c_source_1l00085"/>00085 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00086"/>00086 }
<anchor xml:id="_classification_8c_source_1l00087"/>00087 
<anchor xml:id="_classification_8c_source_1l00096"/>00096 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;add_mangle_rule_str(<emphasis role="keyword">enum</emphasis>&#32;<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1db">class_table</link>&#32;table,&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keywordtype">char</emphasis>&#32;*rule)
<anchor xml:id="_classification_8c_source_1l00097"/>00097 {
<anchor xml:id="_classification_8c_source_1l00098"/>00098 &#32;&#32;&#32;&#32;FILE&#32;*fp&#32;=&#32;NULL;
<anchor xml:id="_classification_8c_source_1l00099"/>00099 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;add_opt&#32;=&#32;(char)&#32;<emphasis role="charliteral">&apos;I&apos;</emphasis>;
<anchor xml:id="_classification_8c_source_1l00100"/>00100 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">size_t</emphasis>&#32;len&#32;=&#32;0;
<anchor xml:id="_classification_8c_source_1l00101"/>00101 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*line&#32;=&#32;NULL;
<anchor xml:id="_classification_8c_source_1l00102"/>00102 
<anchor xml:id="_classification_8c_source_1l00103"/>00103 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!rule)
<anchor xml:id="_classification_8c_source_1l00104"/>00104 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00105"/>00105 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Invalid&#32;arguments\n&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00107"/>00107 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00108"/>00108 
<anchor xml:id="_classification_8c_source_1l00110"/>00110 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!(fp&#32;=&#32;fopen(<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>,&#32;<emphasis role="stringliteral">&quot;a+&quot;</emphasis>)))
<anchor xml:id="_classification_8c_source_1l00111"/>00111 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00112"/>00112 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Cannot&#32;open&#32;&quot;</emphasis><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link><emphasis role="stringliteral">&quot;:&#32;%s\n&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00113"/>00113 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00114"/>00114 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00115"/>00115 
<anchor xml:id="_classification_8c_source_1l00117"/>00117 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(chmod(<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>,&#32;S_IRWXU&#32;|&#32;S_IRWXG&#32;|&#32;S_IRWXO))
<anchor xml:id="_classification_8c_source_1l00118"/>00118 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Cannot&#32;change&#32;&quot;</emphasis><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link><emphasis role="stringliteral">&quot;&#32;permissions:&#32;%s\n&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00119"/>00119 
<anchor xml:id="_classification_8c_source_1l00120"/>00120 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(getline(&amp;line,&#32;&amp;len,&#32;fp)&#32;!=&#32;-1)
<anchor xml:id="_classification_8c_source_1l00121"/>00121 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00122"/>00122 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(strstr(line,&#32;rule))
<anchor xml:id="_classification_8c_source_1l00123"/>00123 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00124"/>00124 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fclose(fp);
<anchor xml:id="_classification_8c_source_1l00125"/>00125 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00126"/>00126 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00127"/>00127 
<anchor xml:id="_classification_8c_source_1l00128"/>00128 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00129"/>00129 
<anchor xml:id="_classification_8c_source_1l00131"/>00131 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*tmpd&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00132"/>00132 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00133"/>00133 
<anchor xml:id="_classification_8c_source_1l00134"/>00134 &#32;&#32;&#32;&#32;strcpy(tmpd,&#32;rule);
<anchor xml:id="_classification_8c_source_1l00136"/>00136 &#32;&#32;&#32;&#32;snprintf(exec,&#32;strlen(tmpd)&#32;+&#32;1,<emphasis role="stringliteral">&quot;%s\n&quot;</emphasis>,&#32;tmpd);
<anchor xml:id="_classification_8c_source_1l00137"/>00137 &#32;&#32;&#32;&#32;free(tmpd);
<anchor xml:id="_classification_8c_source_1l00138"/>00138 
<anchor xml:id="_classification_8c_source_1l00140"/>00140 &#32;&#32;&#32;&#32;exec&#32;=&#32;realloc(exec,&#32;strlen(exec)*&#32;<emphasis role="keyword">sizeof</emphasis>(&#32;<emphasis role="keywordtype">char</emphasis>&#32;));
<anchor xml:id="_classification_8c_source_1l00141"/>00141 
<anchor xml:id="_classification_8c_source_1l00142"/>00142 &#32;&#32;&#32;&#32;exec[20]&#32;=&#32;add_opt;
<anchor xml:id="_classification_8c_source_1l00143"/>00143 &#32;&#32;&#32;&#32;fprintf(fp,&#32;<emphasis role="stringliteral">&quot;%s&quot;</emphasis>,&#32;exec);
<anchor xml:id="_classification_8c_source_1l00144"/>00144 
<anchor xml:id="_classification_8c_source_1l00146"/>00146 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(system(exec))
<anchor xml:id="_classification_8c_source_1l00147"/>00147 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00148"/>00148 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Failed&#32;to&#32;execute&#32;[%s]\n&quot;</emphasis>,&#32;exec);
<anchor xml:id="_classification_8c_source_1l00149"/>00149 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00150"/>00150 
<anchor xml:id="_classification_8c_source_1l00151"/>00151 &#32;&#32;&#32;&#32;free(exec);
<anchor xml:id="_classification_8c_source_1l00152"/>00152 &#32;&#32;&#32;&#32;fclose(fp);
<anchor xml:id="_classification_8c_source_1l00153"/>00153 
<anchor xml:id="_classification_8c_source_1l00154"/>00154 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00155"/>00155 }
<anchor xml:id="_classification_8c_source_1l00156"/>00156 
<anchor xml:id="_classification_8c_source_1l00160"/><link linkend="_structqos__struct">00160</link> <emphasis role="keyword">typedef</emphasis>&#32;<emphasis role="keyword">struct</emphasis>
<anchor xml:id="_classification_8c_source_1l00161"/>00161 {
<anchor xml:id="_classification_8c_source_1l00162"/><link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">00162</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis><link linkend="_structqos__class">qos_class</link>&#32;*<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>;
<anchor xml:id="_classification_8c_source_1l00163"/><link linkend="_structqos__struct_1a854352f53b148adc24983a58a1866d66">00163</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">size_t</emphasis>&#32;<link linkend="_structqos__struct_1a854352f53b148adc24983a58a1866d66">size</link>;
<anchor xml:id="_classification_8c_source_1l00164"/>00164 }&#32;<link linkend="_structqos__struct">qos_struct</link>;
<anchor xml:id="_classification_8c_source_1l00165"/>00165 
<anchor xml:id="_classification_8c_source_1l00171"/><link linkend="_classification_8c_1a152a8b24830cb6d60e74a264ce9787d6">00171</link> <link linkend="_structqos__struct">qos_struct</link>&#32;<link linkend="_classification_8c_1a152a8b24830cb6d60e74a264ce9787d6">initQosClass</link>(<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct</emphasis>&#32;<link linkend="_structqos__class">qos_class</link>&#32;*<emphasis role="keyword">class</emphasis>)
<anchor xml:id="_classification_8c_source_1l00172"/>00172 {
<anchor xml:id="_classification_8c_source_1l00173"/>00173 
<anchor xml:id="_classification_8c_source_1l00174"/>00174 &#32;&#32;&#32;&#32;<link linkend="_structqos__struct">qos_struct</link>&#32;*data&#32;=&#32;malloc(<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structqos__struct">qos_struct</link>));
<anchor xml:id="_classification_8c_source_1l00175"/>00175 
<anchor xml:id="_classification_8c_source_1l00176"/>00176 &#32;&#32;&#32;&#32;data-&gt;<link linkend="_structqos__struct_1a854352f53b148adc24983a58a1866d66">size</link>&#32;=&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structqos__struct">qos_struct</link>);
<anchor xml:id="_classification_8c_source_1l00177"/>00177 &#32;&#32;&#32;&#32;data-&gt;<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>&#32;=&#32;malloc(<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keyword">struct</emphasis>&#32;<link linkend="_structqos__class">qos_class</link>));
<anchor xml:id="_classification_8c_source_1l00178"/>00178 &#32;&#32;&#32;&#32;data-&gt;<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>&#32;=&#32;<emphasis role="keyword">class</emphasis>;
<anchor xml:id="_classification_8c_source_1l00179"/>00179 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;*data;
<anchor xml:id="_classification_8c_source_1l00180"/>00180 }
<anchor xml:id="_classification_8c_source_1l00181"/>00181 
<anchor xml:id="_classification_8c_source_1l00187"/><link linkend="_classification_8c_1a0db1aa13c019518d9b6ca22ddb19b9f9">00187</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classification_8c_1a0db1aa13c019518d9b6ca22ddb19b9f9">dealloc_testclass</link>(<link linkend="_structqos__struct">qos_struct</link>&#32;*<emphasis role="keyword">class</emphasis>)
<anchor xml:id="_classification_8c_source_1l00188"/>00188 {
<anchor xml:id="_classification_8c_source_1l00189"/>00189 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(!<emphasis role="keyword">class</emphasis>)
<anchor xml:id="_classification_8c_source_1l00190"/>00190 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00191"/>00191 
<anchor xml:id="_classification_8c_source_1l00192"/>00192 &#32;&#32;&#32;&#32;free(<emphasis role="keyword">class</emphasis>);
<anchor xml:id="_classification_8c_source_1l00193"/>00193 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00194"/>00194 }
<anchor xml:id="_classification_8c_source_1l00195"/>00195 
<anchor xml:id="_classification_8c_source_1l00200"/><link linkend="_classification_8c_1ae66f6b31b5ad750f1fe042a706a4e3d4">00200</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classification_8c_1ae66f6b31b5ad750f1fe042a706a4e3d4">main</link>()
<anchor xml:id="_classification_8c_source_1l00201"/>00201 {
<anchor xml:id="_classification_8c_source_1l00202"/>00202 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis><link linkend="_structqos__class">qos_class</link>&#32;*test_class&#32;=&#32;malloc(<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keyword">struct</emphasis>&#32;<link linkend="_structqos__class">qos_class</link>));
<anchor xml:id="_classification_8c_source_1l00203"/>00203 
<anchor xml:id="_classification_8c_source_1l00204"/>00204 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1ae7809a8252225b159dd50fa8bed8c6ea">port_dst_range_start</link>&#32;=&#32;-1;
<anchor xml:id="_classification_8c_source_1l00205"/>00205 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1a3d6feeca05393fcec6e0e1231723848f">port_dst_range_end</link>&#32;=&#32;-1;
<anchor xml:id="_classification_8c_source_1l00206"/>00206 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1a8d5d9e349e89e6ba9821079a8fc7e82b">port_src_range_start</link>&#32;=&#32;-1;
<anchor xml:id="_classification_8c_source_1l00207"/>00207 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1a3df65ce0201e7fd13c4baa1f5d327518">port_src_range_end</link>&#32;=&#32;-1;
<anchor xml:id="_classification_8c_source_1l00208"/>00208 
<anchor xml:id="_classification_8c_source_1l00209"/>00209 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1ab30e8d7e05ae904d3248e0d51255c005">protocol</link>&#32;=&#32;-1;
<anchor xml:id="_classification_8c_source_1l00210"/>00210 
<anchor xml:id="_classification_8c_source_1l00211"/>00211 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1a027232db91aaa16ed881f8c2c346a8b6">traffic_class</link>&#32;=&#32;2;
<anchor xml:id="_classification_8c_source_1l00212"/>00212 &#32;&#32;&#32;&#32;strcpy(test_class-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;<emphasis role="stringliteral">&quot;postrouting_qos&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00213"/>00213 &#32;&#32;&#32;&#32;strcpy(test_class-&gt;<link linkend="_structqos__class_1aac0ca8abb088579b646d489f553b8fb2">iface_out</link>,&#32;<emphasis role="stringliteral">&quot;erouter0&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00214"/>00214 &#32;&#32;&#32;&#32;strcpy(test_class-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>,&#32;<emphasis role="stringliteral">&quot;brlan0&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00215"/>00215 &#32;&#32;&#32;&#32;test_class-&gt;<link linkend="_structqos__class_1ab97cecfa4da3088f30c4bc263b47bee8">dscp_mark</link>&#32;=&#32;32;
<anchor xml:id="_classification_8c_source_1l00216"/>00216 
<anchor xml:id="_classification_8c_source_1l00217"/>00217 &#32;&#32;&#32;&#32;strcpy(test_class-&gt;<link linkend="_structqos__class_1a9c3c1418ce5a5c9c588cef92da7409cd">mac_src_addr</link>,&#32;<emphasis role="stringliteral">&quot;00:e0:4c:81:c8:41&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00218"/>00218 
<anchor xml:id="_classification_8c_source_1l00219"/>00219 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(<link linkend="_classification_8c_1a2f2af0ce3ad3f1c2878c30c12df8795c">qos_addClass</link>(test_class)&#32;==&#32;-1)
<anchor xml:id="_classification_8c_source_1l00220"/>00220 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;EXIT_FAILURE;
<anchor xml:id="_classification_8c_source_1l00221"/>00221 
<anchor xml:id="_classification_8c_source_1l00222"/>00222 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;EXIT_SUCCESS;
<anchor xml:id="_classification_8c_source_1l00223"/>00223 }
<anchor xml:id="_classification_8c_source_1l00224"/>00224 
<anchor xml:id="_classification_8c_source_1l00250"/><link linkend="_classification_8c_1a2f2af0ce3ad3f1c2878c30c12df8795c">00250</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classification_8c_1a2f2af0ce3ad3f1c2878c30c12df8795c">qos_addClass</link>(<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct</emphasis>&#32;<link linkend="_structqos__class">qos_class</link>&#32;*param)
<anchor xml:id="_classification_8c_source_1l00251"/>00251 {
<anchor xml:id="_classification_8c_source_1l00252"/>00252 &#32;&#32;&#32;&#32;<link linkend="_structqos__struct">qos_struct</link>&#32;obj&#32;=&#32;<link linkend="_classification_8c_1a152a8b24830cb6d60e74a264ce9787d6">initQosClass</link>(param);
<anchor xml:id="_classification_8c_source_1l00253"/>00253 
<anchor xml:id="_classification_8c_source_1l00254"/>00254 &#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Parameters:&#32;%d,&#32;%s,&#32;%d&quot;</emphasis>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab97cecfa4da3088f30c4bc263b47bee8">dscp_mark</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a9c3c1418ce5a5c9c588cef92da7409cd">mac_src_addr</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a027232db91aaa16ed881f8c2c346a8b6">traffic_class</link>);
<anchor xml:id="_classification_8c_source_1l00255"/>00255 
<anchor xml:id="_classification_8c_source_1l00256"/>00256 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a3df65ce0201e7fd13c4baa1f5d327518">port_src_range_end</link>&#32;==&#32;-1&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00257"/>00257 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a8d5d9e349e89e6ba9821079a8fc7e82b">port_src_range_start</link>&#32;==&#32;-1&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00258"/>00258 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a3d6feeca05393fcec6e0e1231723848f">port_dst_range_end</link>&#32;==&#32;-1&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00259"/>00259 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ae7809a8252225b159dd50fa8bed8c6ea">port_dst_range_start</link>&#32;==&#32;-1&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00260"/>00260 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab30e8d7e05ae904d3248e0d51255c005">protocol</link>&#32;==&#32;-1&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00261"/>00261 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a027232db91aaa16ed881f8c2c346a8b6">traffic_class</link>&#32;!=&#32;0&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00262"/>00262 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>[0]&#32;!=&#32;<emphasis role="charliteral">&apos;\0&apos;</emphasis>&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00263"/>00263 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>[0]&#32;!=&#32;<emphasis role="charliteral">&apos;\0&apos;</emphasis>&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00264"/>00264 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1aac0ca8abb088579b646d489f553b8fb2">iface_out</link>[0]&#32;!=&#32;<emphasis role="charliteral">&apos;\0&apos;</emphasis>&#32;&amp;&amp;
<anchor xml:id="_classification_8c_source_1l00265"/>00265 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab97cecfa4da3088f30c4bc263b47bee8">dscp_mark</link>&#32;!=&#32;0
<anchor xml:id="_classification_8c_source_1l00266"/>00266 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;)
<anchor xml:id="_classification_8c_source_1l00267"/>00267 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00268"/>00268 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;NEW&#32;mark&#32;Categ&#32;add&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00269"/>00269 
<anchor xml:id="_classification_8c_source_1l00271"/>00271 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;revert_rules();
<anchor xml:id="_classification_8c_source_1l00272"/>00272 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classification_8c_1a733ca25bba1c57325e812bd4c01e0b95">qos_removeAllClasses</link>();
<anchor xml:id="_classification_8c_source_1l00273"/>00273 
<anchor xml:id="_classification_8c_source_1l00275"/>00275 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec1&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00277"/>00277 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;snprintf(exec1,&#32;255,&#32;<emphasis role="stringliteral">&quot;%s&#32;-I&#32;%s&#32;-o&#32;%s&#32;-m&#32;mark&#32;--mark&#32;4444&#32;-j&#32;DSCP&#32;--set-dscp&#32;%d&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">CLASS_IPTABLES_MANGLE_CMD</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1aac0ca8abb088579b646d489f553b8fb2">iface_out</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab97cecfa4da3088f30c4bc263b47bee8">dscp_mark</link>);
<anchor xml:id="_classification_8c_source_1l00279"/>00279 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;exec1&#32;=&#32;realloc(exec1,&#32;strlen(exec1)*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">char</emphasis>&#32;));
<anchor xml:id="_classification_8c_source_1l00280"/>00280 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;%s&#32;\n&quot;</emphasis>,&#32;exec1);
<anchor xml:id="_classification_8c_source_1l00281"/>00281 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//system(exec1);</emphasis>
<anchor xml:id="_classification_8c_source_1l00283"/>00283 <emphasis role="comment"></emphasis>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;add_mangle_rule_str(<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>,&#32;exec1);
<anchor xml:id="_classification_8c_source_1l00285"/>00285 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;free(exec1);
<anchor xml:id="_classification_8c_source_1l00286"/>00286 
<anchor xml:id="_classification_8c_source_1l00287"/>00287 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec2&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00288"/>00288 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;snprintf(exec2,&#32;255,&#32;<emphasis role="stringliteral">&quot;%s&#32;-I&#32;%s&#32;-o&#32;%s&#32;-m&#32;mark&#32;--mark&#32;4444&#32;-j&#32;DSCP&#32;--set-dscp&#32;%d&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">CLASS_IPTABLES_MANGLE_CMD</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab97cecfa4da3088f30c4bc263b47bee8">dscp_mark</link>);
<anchor xml:id="_classification_8c_source_1l00289"/>00289 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;exec2&#32;=&#32;realloc(exec2,&#32;strlen(exec2)*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">char</emphasis>&#32;));
<anchor xml:id="_classification_8c_source_1l00290"/>00290 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;%s&#32;\n&quot;</emphasis>,&#32;exec2);
<anchor xml:id="_classification_8c_source_1l00291"/>00291 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;add_mangle_rule_str(<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>,&#32;exec2);
<anchor xml:id="_classification_8c_source_1l00292"/>00292 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;free(exec2);
<anchor xml:id="_classification_8c_source_1l00293"/>00293 
<anchor xml:id="_classification_8c_source_1l00294"/>00294 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec3&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00295"/>00295 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;snprintf(exec3,&#32;255,&#32;<emphasis role="stringliteral">&quot;%s&#32;-I&#32;%s&#32;-o&#32;%s&#32;-m&#32;state&#32;--state&#32;ESTABLISHED,RELATED&#32;-j&#32;CONNMARK&#32;--restore-mark&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">CLASS_IPTABLES_MANGLE_CMD</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>);
<anchor xml:id="_classification_8c_source_1l00296"/>00296 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;exec3&#32;=&#32;realloc(exec3,&#32;strlen(exec3)&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">char</emphasis>&#32;));
<anchor xml:id="_classification_8c_source_1l00297"/>00297 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;%s&#32;\n&quot;</emphasis>,&#32;exec3);
<anchor xml:id="_classification_8c_source_1l00298"/>00298 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//system(exec3);</emphasis>
<anchor xml:id="_classification_8c_source_1l00299"/>00299 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;add_mangle_rule_str(<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>,&#32;exec3);
<anchor xml:id="_classification_8c_source_1l00300"/>00300 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;free(exec3);
<anchor xml:id="_classification_8c_source_1l00301"/>00301 
<anchor xml:id="_classification_8c_source_1l00302"/>00302 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec4&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00303"/>00303 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;snprintf(exec4,&#32;255,&#32;<emphasis role="stringliteral">&quot;%s&#32;-I&#32;%s&#32;-o&#32;%s&#32;-m&#32;state&#32;--state&#32;NEW&#32;-m&#32;mac&#32;--mac-source&#32;%s&#32;-j&#32;CONNMARK&#32;--save-mark&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">CLASS_IPTABLES_MANGLE_CMD</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a9c3c1418ce5a5c9c588cef92da7409cd">mac_src_addr</link>);
<anchor xml:id="_classification_8c_source_1l00304"/>00304 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;exec4&#32;=&#32;realloc(exec4,&#32;strlen(exec4)&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">char</emphasis>&#32;));
<anchor xml:id="_classification_8c_source_1l00305"/>00305 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;%s&#32;\n&quot;</emphasis>,&#32;exec4);
<anchor xml:id="_classification_8c_source_1l00306"/>00306 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//system(exec4);</emphasis>
<anchor xml:id="_classification_8c_source_1l00307"/>00307 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;add_mangle_rule_str(<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>,&#32;exec4);
<anchor xml:id="_classification_8c_source_1l00308"/>00308 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;free(exec4);
<anchor xml:id="_classification_8c_source_1l00309"/>00309 
<anchor xml:id="_classification_8c_source_1l00310"/>00310 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*exec5&#32;=&#32;(<emphasis role="keywordtype">char</emphasis>&#32;*)&#32;malloc(255);
<anchor xml:id="_classification_8c_source_1l00311"/>00311 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;snprintf(exec5,&#32;200,&#32;<emphasis role="stringliteral">&quot;%s&#32;-I&#32;%s&#32;-o&#32;%s&#32;-m&#32;state&#32;--state&#32;NEW&#32;-m&#32;mac&#32;--mac-source&#32;%s&#32;-j&#32;MARK&#32;--set-mark&#32;4444&quot;</emphasis>,&#32;<link linkend="_classification_8c_1a157effcdb39a9359a985714593fa0870">CLASS_IPTABLES_MANGLE_CMD</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1afe07e58af3480c344fa6336194405f20">chain_name</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1ab47b524511e925a416f40f401fb736f0">iface_in</link>,&#32;obj.<link linkend="_structqos__struct_1a0ee85158e77ae13dc38dea08882a5b82">data</link>-&gt;<link linkend="_structqos__class_1a9c3c1418ce5a5c9c588cef92da7409cd">mac_src_addr</link>);
<anchor xml:id="_classification_8c_source_1l00312"/>00312 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;%s&#32;\n&quot;</emphasis>,&#32;exec5);
<anchor xml:id="_classification_8c_source_1l00313"/>00313 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//system(exec5);</emphasis>
<anchor xml:id="_classification_8c_source_1l00314"/>00314 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;add_mangle_rule_str(<link linkend="_classification_8c_1a9e6af64356c2d601cdb49b676d4fe1dba781b1fdbefbe39fc6edf90430244c503">IPTABLES_IPV4</link>,&#32;exec5);
<anchor xml:id="_classification_8c_source_1l00315"/>00315 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;free(exec5);
<anchor xml:id="_classification_8c_source_1l00316"/>00316 
<anchor xml:id="_classification_8c_source_1l00318"/>00318 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(!append_to_fw())&#32;{
<anchor xml:id="_classification_8c_source_1l00319"/>00319 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Failed&#32;to&#32;set&#32;iptables&#32;rules&#32;via&#32;firewall&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00320"/>00320 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00321"/>00321 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00322"/>00322 &#32;&#32;&#32;&#32;}&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
<anchor xml:id="_classification_8c_source_1l00323"/>00323 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;STD&#32;QoS&#32;Class&#32;add&quot;</emphasis>);
<anchor xml:id="_classification_8c_source_1l00324"/>00324 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00325"/>00325 
<anchor xml:id="_classification_8c_source_1l00326"/>00326 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00327"/>00327 }
<anchor xml:id="_classification_8c_source_1l00328"/>00328 
<anchor xml:id="_classification_8c_source_1l00329"/><link linkend="_classification_8c_1a733ca25bba1c57325e812bd4c01e0b95">00329</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classification_8c_1a733ca25bba1c57325e812bd4c01e0b95">qos_removeAllClasses</link>()
<anchor xml:id="_classification_8c_source_1l00330"/>00330 {
<anchor xml:id="_classification_8c_source_1l00331"/>00331 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(remove(<link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link>)&#32;==&#32;-1)
<anchor xml:id="_classification_8c_source_1l00332"/>00332 &#32;&#32;&#32;&#32;{
<anchor xml:id="_classification_8c_source_1l00333"/>00333 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;Failed&#32;to&#32;remove&#32;&quot;</emphasis><link linkend="_classification_8c_1a7562d6fb7949c4e14a05fcbcc38fbf64">CLASS_FW_FILENAME</link><emphasis role="stringliteral">&quot;:&#32;%s&quot;</emphasis>,&#32;strerror(errno));
<anchor xml:id="_classification_8c_source_1l00334"/>00334 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_classification_8c_source_1l00335"/>00335 &#32;&#32;&#32;&#32;}
<anchor xml:id="_classification_8c_source_1l00336"/>00336 
<anchor xml:id="_classification_8c_source_1l00337"/>00337 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_classification_8c_source_1l00338"/>00338 }
</programlisting></section>
